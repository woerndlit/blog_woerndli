# This is a basic workflow to help you get started with Actions

name: Deploy (manual)

# Workflow is manual to avoid accidental deploys during testing.
on:
  workflow_dispatch: {}
    

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'
      - name: Restore, Build and Run
        run: |
          dotnet restore
          dotnet build --configuration Release --no-restore
          dotnet run --configuration Release --no-build
      - uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      - uses: azure/CLI@v1
        with:
          inlineScript: az storage blob delete-batch --account-name ${{ secrets.STORAGE_ACCOUNT_NAME }} -s '$web'
      - uses: azure/CLI@v1
        with:
          inlineScript: az storage blob upload-batch --account-name ${{ secrets.STORAGE_ACCOUNT_NAME }} -d '$web' -s ./output
      - uses: azure/CLI@v1
        with:
          inlineScript: az storage blob upload-batch --account-name ${{ secrets.STORAGE_ACCOUNT_NAME }} -d '$web' -s ./output --pattern *.html --content-type text/html
      - uses: azure/CLI@v1
        with:
          inlineScript: az cdn endpoint purge --content-paths "/*" --profile-name "${{ secrets.CDN_PROFILE_NAME }}" --name "${{ secrets.CDN_ENDPOINT }}" --resource-group "${{ secrets.RESOURCE_GROUP }}"         
      - run: |
              az logout
